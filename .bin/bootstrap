#!/bin/bash

WORKSPACE_DIR="/workspaces/codespaces-blank/cis190_codespace"
BIN_PATH="$(dirname "$(realpath "$0")")"
SHELL_RC="$HOME/.bashrc"  # Or use detection if students may use zsh
ALIASES_FILE="$HOME/.bash_aliases"
PROFILE_DIR="${BIN_PATH}/../.db"
PYTHON_DIR="${BIN_PATH}/../.python"
PROFILE_DB="${PROFILE_DIR}/profile.sqlite3"

echo "✅ Installing necessary packages and setting up environment..."
echo "🕒 Please wait, this may take a few minutes..."
sudo apt update -y -qq
sudo apt install -y -qq tmux dialog
python3 -m pip install --quiet  --upgrade pip
(cd $PYTHON_DIR&&python3 -m venv venv&&source venv/bin/activate&&pip install --quiet --upgrade pip&&pip install --quiet -r requirements.txt)
if [[ ":$PATH:" != *":$BIN_PATH:"* ]]; then
echo "export PATH=\"$BIN_PATH:\$PATH\"" >> "$SHELL_RC"
echo "export SUBMIT_URL=https://cis.vvc.edu/submit_assignment/submit-file" >> "$SHELL_RC"  
echo "announce" >> "$SHELL_RC"
cat <<'EOS' >> $SHELL_RC
EOS
cat <<'EOF' >> "$ALIASES_FILE"
# Aliases for student management
# This file is automatically generated by the bootstrap script.
# Do not edit this file directly.
export WORKSPACE_DIR=/workspaces/codespaces-blank/cis190_codespace
function quiz() {
  (cd ${WORKSPACE_DIR}/.python && ./run_quiz.sh "$@")
}
export -f quiz
function update() {
  (cd ${WORKSPACE_DIR} && git pull -q && echo "Updated!")
}
export -f update
function missions() {
  (cd ${WORKSPACE_DIR}/missions && ls -1)
}
export -f missions
alias play='asciinema play'
alias record='asciinema rec'
EOF
  export PATH="$BIN_PATH:$PATH"
fi
if [[ ! -d $BIN_PATH ]];then
  mkdir -p $BIN_PATH
fi

if [[ ! -d $PROFILE_DIR ]];then
  mkdir -p $PROFILE_DIR
fi
#if [[ ! -f $PROFILE_DB ]];then
python3 ${BIN_PATH}/get_student_info.py --db=${PROFILE_DB}
#fi

if [[ ! -x ${BIN_PATH}/start ]];then
   chmod +x ${BIN_PATH}/start
fi
# Ensure pip is available
if ! command -v pip3 &> /dev/null; then
    echo "❌ pip not found. Please install Python and pip first."
    echo " You can install pip using your package manager, for example:"
    echo "   sudo apt install python3-pip"
    exit 1
fi

for PACKAGE in rich asciinema;do
	if ! pip3 show "$PACKAGE" > /dev/null 2>&1; then
	    pip3 install --no-warn-script-location --quiet "$PACKAGE"
	fi
done

echo
echo "🚀 bootstrap was successful, remember, you only need to run this once"
echo "✅ To use new changes immediately, either restart your terminal or run "
echo "   the following command:"
echo
echo "    source $SHELL_RC"
echo
